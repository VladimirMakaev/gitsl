---
phase: 20-critical-safety-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd_commit.py
  - cmd_checkout.py
  - tests/test_commit.py
  - tests/test_checkout.py
  - tests/test_branch.py
autonomous: true

must_haves:
  truths:
    - "User running `git commit -a` commits only tracked modified files, not untracked files"
    - "User running `git checkout -f <branch>` can switch branches while discarding uncommitted changes"
    - "User running `git checkout -m <branch>` merges local changes during branch switch"
    - "User running `git branch -D <name>` deletes only the bookmark label, never strips commits"
  artifacts:
    - path: "cmd_commit.py"
      provides: "Commit handler with -a flag removal"
      contains: "-a.*--all"
    - path: "cmd_checkout.py"
      provides: "Checkout handler with -f/-m flag translation"
      contains: "-C"
    - path: "tests/test_commit.py"
      provides: "Safety tests for commit -a behavior"
      contains: "test_commit_a"
    - path: "tests/test_checkout.py"
      provides: "Safety tests for checkout -f/-m behavior"
      contains: "test_checkout_force"
  key_links:
    - from: "cmd_commit.py"
      to: "sl commit"
      via: "run_sl with -a filtered out"
      pattern: "a for a in args if a not in"
    - from: "cmd_checkout.py"
      to: "sl goto"
      via: "-f translated to -C"
      pattern: "-C.*-f.*--force"
---

<objective>
Implement critical safety fixes for git flags that have dangerous semantic differences between git and Sapling.

Purpose: Protect users from data loss or unexpected file additions when using common git flags that behave differently in sl. These are safety-critical fixes that must be implemented before other v1.3 features.

Output: Updated cmd_commit.py and cmd_checkout.py with safe flag handling, comprehensive test coverage for all four SAFE requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-critical-safety-fixes/20-RESEARCH.md

# Existing implementations to modify
@cmd_commit.py
@cmd_checkout.py
@cmd_branch.py

# Existing test patterns to follow
@tests/test_branch.py
@tests/test_checkout.py
@tests/test_commit.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SAFE-01 - Remove commit -a flag</name>
  <files>cmd_commit.py, tests/test_commit.py</files>
  <action>
Modify cmd_commit.py to remove -a/--all flags before passing to sl commit.

**Why this is critical:**
- git commit -a: stages and commits tracked modified/deleted files only
- sl commit -A: runs addremove, which ADDS untracked files (dangerous!)
- Silently removing the flag is safer than warning (prevents accidental additions)

**Implementation:**
In cmd_commit.py handle() function, add flag filtering before run_sl:

```python
def handle(parsed: ParsedCommand) -> int:
    args = list(parsed.args)

    # SAFE-01: Remove -a/--all flags
    # git -a: stage tracked modified/deleted files only
    # sl -A: addremove - adds untracked files (DANGEROUS!)
    # Removing the flag is safe: sl commit without -A behaves like git commit without -a
    args = [a for a in args if a not in ('-a', '--all')]

    return run_sl(["commit"] + args)
```

**Add tests to tests/test_commit.py:**
Create new class TestCommitSafety with tests:

1. test_commit_a_does_not_add_untracked: Create untracked file, modify tracked file, run commit -a, verify untracked file is still untracked
2. test_commit_all_long_form: Same test with --all flag
3. test_commit_a_with_message: Verify commit -a -m "msg" works (flag order doesn't matter)

Follow the existing test pattern in test_branch.py for safety tests.
  </action>
  <verify>
Run tests: `cd /Users/vmakaev/NonWork/gitsl && python -m pytest tests/test_commit.py -v`
All tests pass including new safety tests.
  </verify>
  <done>
- cmd_commit.py filters out -a and --all flags
- tests/test_commit.py has TestCommitSafety class with 3 tests
- All commit tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SAFE-02 and SAFE-03 - Checkout force/merge flags</name>
  <files>cmd_checkout.py, tests/test_checkout.py</files>
  <action>
Modify cmd_checkout.py to translate -f/--force to -C and handle -m/--merge for sl goto.

**Why this is needed:**
- git checkout -f: discard uncommitted changes when switching branches
- sl goto -C: clean/discard uncommitted changes (equivalent)
- git checkout -m: merge uncommitted changes during switch
- sl goto -m: same semantics (passes through)

**Implementation:**
The -f and -m flags only apply to branch switching (goto), NOT to file restoration (revert).

1. Create a helper function to translate checkout flags for goto:

```python
def _translate_goto_flags(args: List[str]) -> List[str]:
    """Translate git checkout flags to sl goto flags for branch switching."""
    result = []
    for arg in args:
        if arg in ('-f', '--force'):
            result.append('-C')  # sl goto --clean
        else:
            result.append(arg)
    return result
```

2. Apply this translation in all places where run_sl(["goto", ...]) is called:
   - In _handle_create_branch() for the goto at the end
   - In handle() where goto is called for revision switching (line 147)

3. The -m/--merge flag passes through unchanged (same semantics in sl goto).

**Add tests to tests/test_checkout.py:**
Create new class TestCheckoutForce (SAFE-02):
1. test_checkout_force_discards_changes: Create uncommitted changes, checkout -f to another branch, verify changes are discarded
2. test_checkout_force_long_form: Same with --force

Create new class TestCheckoutMerge (SAFE-03):
1. test_checkout_merge_attempts_merge: Create non-conflicting changes, checkout -m to branch, verify changes are merged
2. test_checkout_merge_long_form: Same with --merge
  </action>
  <verify>
Run tests: `cd /Users/vmakaev/NonWork/gitsl && python -m pytest tests/test_checkout.py -v`
All tests pass including new force/merge tests.
  </verify>
  <done>
- cmd_checkout.py translates -f/--force to -C for goto commands
- cmd_checkout.py passes -m/--merge through to goto
- tests/test_checkout.py has TestCheckoutForce class with 2 tests
- tests/test_checkout.py has TestCheckoutMerge class with 2 tests
- All checkout tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify SAFE-04 - Branch -D test coverage</name>
  <files>tests/test_branch.py</files>
  <action>
Verify that SAFE-04 (branch -D to -d translation) has complete test coverage.

**Current state (from research):**
- Implementation exists in cmd_branch.py line 24
- Test exists: test_branch_force_delete_preserves_commits

**Verification steps:**
1. Review existing test_branch.py TestBranchForceDelete class
2. Verify test_branch_force_delete_preserves_commits covers the safety behavior
3. Add any missing edge cases if needed:
   - test_branch_D_translates_to_d: Explicitly verify the translation happens (not just that commits are preserved)

**If additional test needed:**
```python
def test_branch_D_translates_to_lowercase_d(self, sl_repo_with_commit: Path):
    """git branch -D uses -d flag to ensure safe delete."""
    run_command(["sl", "bookmark", "test-delete"], cwd=sl_repo_with_commit)

    # -D should translate to -d and succeed
    result = run_gitsl(["branch", "-D", "test-delete"], cwd=sl_repo_with_commit)
    assert result.exit_code == 0

    # Bookmark should be deleted
    bookmarks = run_command(["sl", "bookmark"], cwd=sl_repo_with_commit)
    assert "test-delete" not in bookmarks.stdout
```

Run full test suite to confirm all safety requirements are covered.
  </action>
  <verify>
Run all tests: `cd /Users/vmakaev/NonWork/gitsl && python -m pytest tests/test_branch.py tests/test_commit.py tests/test_checkout.py -v`
All tests pass. SAFE-04 has explicit test coverage.
  </verify>
  <done>
- tests/test_branch.py has complete coverage for -D to -d translation
- All branch, commit, and checkout safety tests pass
- All four SAFE requirements are implemented and tested
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run full safety test suite:
```bash
cd /Users/vmakaev/NonWork/gitsl
python -m pytest tests/test_commit.py tests/test_checkout.py tests/test_branch.py -v
```

2. Run complete test suite to verify no regressions:
```bash
python -m pytest tests/ -v
```

3. Manual verification of each requirement:
- SAFE-01: `git commit -a` does not add untracked files
- SAFE-02: `git checkout -f <branch>` discards changes and switches
- SAFE-03: `git checkout -m <branch>` merges changes during switch
- SAFE-04: `git branch -D <name>` deletes label without stripping commits
</verification>

<success_criteria>
1. All four SAFE requirements implemented and tested
2. No regressions in existing test suite
3. Safety tests explicitly verify the dangerous behavior is prevented
4. Code follows existing patterns (flag filtering in cmd_branch.py)
</success_criteria>

<output>
After completion, create `.planning/phases/20-critical-safety-fixes/20-01-SUMMARY.md`
</output>
