name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  SAPLING_CACHE_VERSION: "3"  # Bump to invalidate cache

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Use ubuntu-22.04 because Sapling .deb is built for 22.04
        os: [ubuntu-22.04, macos-latest, windows-latest]
        python-version: ["3.9", "3.11", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get latest Sapling release info
        id: sapling-release
        shell: bash
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/facebook/sapling/releases/latest)
          # Use jq which is available on all GitHub runners
          TAG_NAME=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
          TAG_ENCODED=$(echo "$TAG_NAME" | sed 's/+/%2B/g')
          echo "version_encoded=$TAG_ENCODED" >> $GITHUB_OUTPUT
          echo "Sapling version: $TAG_NAME"

      # ==================== LINUX ====================
      - name: Cache Sapling deb (Linux)
        if: runner.os == 'Linux'
        id: cache-sapling-linux
        uses: actions/cache@v4
        with:
          path: ~/.cache/sapling
          key: sapling-deb-${{ steps.sapling-release.outputs.version }}-v${{ env.SAPLING_CACHE_VERSION }}

      - name: Download Sapling (Linux)
        if: runner.os == 'Linux' && steps.cache-sapling-linux.outputs.cache-hit != 'true'
        run: |
          SAPLING_VERSION="${{ steps.sapling-release.outputs.version }}"
          SAPLING_VERSION_ENCODED="${{ steps.sapling-release.outputs.version_encoded }}"
          mkdir -p ~/.cache/sapling
          echo "Downloading Sapling $SAPLING_VERSION..."
          curl -L -o ~/.cache/sapling/sapling.deb \
            "https://github.com/facebook/sapling/releases/download/${SAPLING_VERSION_ENCODED}/sapling_${SAPLING_VERSION}_amd64.Ubuntu22.04.deb"

      - name: Install Sapling (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo dpkg -i ~/.cache/sapling/sapling.deb || sudo apt-get install -f -y
          sl --version

      # ==================== macOS ====================
      - name: Install Sapling (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install sapling
          sl --version

      # ==================== WINDOWS ====================
      - name: Cache Sapling (Windows)
        if: runner.os == 'Windows'
        id: cache-sapling-windows
        uses: actions/cache@v4
        with:
          path: C:\sapling
          key: sapling-windows-${{ steps.sapling-release.outputs.version }}-v${{ env.SAPLING_CACHE_VERSION }}

      - name: Install Sapling (Windows)
        if: runner.os == 'Windows' && steps.cache-sapling-windows.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $SAPLING_VERSION = "${{ steps.sapling-release.outputs.version }}"
          $SAPLING_VERSION_ENCODED = "${{ steps.sapling-release.outputs.version_encoded }}"
          $INSTALL_DIR = "C:\sapling"

          Write-Host "Downloading Sapling $SAPLING_VERSION..."
          $url = "https://github.com/facebook/sapling/releases/download/$SAPLING_VERSION_ENCODED/sapling_windows_${SAPLING_VERSION}_amd64.zip"
          Invoke-WebRequest -Uri $url -OutFile sapling.zip

          New-Item -ItemType Directory -Force -Path $INSTALL_DIR | Out-Null
          Expand-Archive sapling.zip -DestinationPath $INSTALL_DIR -Force

          # Flatten - the zip contains a subdirectory
          $subdir = Get-ChildItem -Path $INSTALL_DIR -Directory | Select-Object -First 1
          if ($subdir) {
            Get-ChildItem -Path $subdir.FullName | Move-Item -Destination $INSTALL_DIR -Force
            Remove-Item $subdir.FullName -Recurse -Force
          }

          Remove-Item sapling.zip -Force

      - name: Setup Sapling PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "C:\sapling" >> $env:GITHUB_PATH
          Remove-Alias -Name sl -Force -Scope Global -ErrorAction SilentlyContinue
          & "C:\sapling\sl.exe" --version

      - name: Remove sl alias (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Remove-Alias -Name sl -Force -Scope Global -ErrorAction SilentlyContinue

      # ==================== TESTS ====================
      - name: Install test dependencies
        run: pip install pytest

      - name: Debug environment
        shell: bash
        run: |
          echo "=== PATH ==="
          echo $PATH
          echo "=== which sl ==="
          which sl || echo "sl not found"
          echo "=== which git ==="
          which git
          echo "=== Python ==="
          python --version || python3 --version
          echo "=== pytest location ==="
          which pytest
          echo "=== List tests dir ==="
          ls -la tests/

      - name: Run tests
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          echo "=== Environment Info ==="
          echo "RUNNER_OS: $RUNNER_OS"
          echo "PWD: $(pwd)"
          echo "Python: $(python --version)"
          echo "Pytest: $(pytest --version)"

          echo "=== Verifying sl is accessible ==="
          # On Windows, sl.exe is in C:\sapling which should be in PATH
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "Windows detected, checking sl.exe..."
            ls -la /c/sapling/ 2>/dev/null || echo "C:\sapling not found or empty"
            /c/sapling/sl.exe --version 2>&1 || echo "sl.exe not working"
            # Also check if shutil.which finds it
            python -c "import shutil; print('shutil.which sl:', shutil.which('sl'))"
          else
            which sl && sl --version || echo "sl command not found in PATH"
          fi

          echo "=== Checking pytest.ini ==="
          cat pytest.ini

          echo "=== Testing imports before pytest ==="
          python -c "
import sys
print('sys.path:', sys.path[:5])
sys.path.insert(0, 'tests')
print('After adding tests to path:', sys.path[:5])

# Test the import chain
try:
    from helpers.commands import CommandResult, run_command
    print('helpers.commands imported OK')
except Exception as e:
    print('helpers.commands FAILED:', e)

try:
    import conftest
    print('conftest imported OK')
except Exception as e:
    print('conftest FAILED:', e)

try:
    from conftest import run_gitsl
    print('run_gitsl imported OK')
except Exception as e:
    print('run_gitsl import FAILED:', e)

import shutil
sl = shutil.which('sl')
print('shutil.which(sl):', sl)
"

          echo "=== Running actual tests ==="
          pytest tests/test_init.py -v --tb=long 2>&1 || {
            echo "=== TEST FAILED ==="
            exit 1
          }
