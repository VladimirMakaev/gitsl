name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  SAPLING_CACHE_VERSION: "3"  # Bump to invalidate cache

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Use ubuntu-22.04 because Sapling .deb is built for 22.04
        os: [ubuntu-22.04, macos-latest, windows-latest]
        python-version: ["3.9", "3.11", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get latest Sapling release info
        id: sapling-release
        shell: bash
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/facebook/sapling/releases/latest)
          # Use jq which is available on all GitHub runners
          TAG_NAME=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
          TAG_ENCODED=$(echo "$TAG_NAME" | sed 's/+/%2B/g')
          echo "version_encoded=$TAG_ENCODED" >> $GITHUB_OUTPUT
          echo "Sapling version: $TAG_NAME"

      # ==================== LINUX ====================
      - name: Cache Sapling deb (Linux)
        if: runner.os == 'Linux'
        id: cache-sapling-linux
        uses: actions/cache@v4
        with:
          path: ~/.cache/sapling
          key: sapling-deb-${{ steps.sapling-release.outputs.version }}-v${{ env.SAPLING_CACHE_VERSION }}

      - name: Download Sapling (Linux)
        if: runner.os == 'Linux' && steps.cache-sapling-linux.outputs.cache-hit != 'true'
        run: |
          SAPLING_VERSION="${{ steps.sapling-release.outputs.version }}"
          SAPLING_VERSION_ENCODED="${{ steps.sapling-release.outputs.version_encoded }}"
          mkdir -p ~/.cache/sapling
          echo "Downloading Sapling $SAPLING_VERSION..."
          curl -L -o ~/.cache/sapling/sapling.deb \
            "https://github.com/facebook/sapling/releases/download/${SAPLING_VERSION_ENCODED}/sapling_${SAPLING_VERSION}_amd64.Ubuntu22.04.deb"

      - name: Install Sapling (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo dpkg -i ~/.cache/sapling/sapling.deb || sudo apt-get install -f -y
          sl --version

      # ==================== macOS ====================
      - name: Install Sapling (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install sapling
          sl --version

      # ==================== WINDOWS ====================
      - name: Cache Sapling (Windows)
        if: runner.os == 'Windows'
        id: cache-sapling-windows
        uses: actions/cache@v4
        with:
          path: C:\sapling
          key: sapling-windows-${{ steps.sapling-release.outputs.version }}-v${{ env.SAPLING_CACHE_VERSION }}

      - name: Install Sapling (Windows)
        if: runner.os == 'Windows' && steps.cache-sapling-windows.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $SAPLING_VERSION = "${{ steps.sapling-release.outputs.version }}"
          $SAPLING_VERSION_ENCODED = "${{ steps.sapling-release.outputs.version_encoded }}"
          $INSTALL_DIR = "C:\sapling"

          Write-Host "Downloading Sapling $SAPLING_VERSION..."
          $url = "https://github.com/facebook/sapling/releases/download/$SAPLING_VERSION_ENCODED/sapling_windows_${SAPLING_VERSION}_amd64.zip"
          Invoke-WebRequest -Uri $url -OutFile sapling.zip

          New-Item -ItemType Directory -Force -Path $INSTALL_DIR | Out-Null
          Expand-Archive sapling.zip -DestinationPath $INSTALL_DIR -Force

          # Flatten - the zip contains a subdirectory
          $subdir = Get-ChildItem -Path $INSTALL_DIR -Directory | Select-Object -First 1
          if ($subdir) {
            Get-ChildItem -Path $subdir.FullName | Move-Item -Destination $INSTALL_DIR -Force
            Remove-Item $subdir.FullName -Recurse -Force
          }

          Remove-Item sapling.zip -Force

      - name: Setup Sapling PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "C:\sapling" >> $env:GITHUB_PATH
          Remove-Alias -Name sl -Force -Scope Global -ErrorAction SilentlyContinue
          & "C:\sapling\sl.exe" --version

      - name: Remove sl alias (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Remove-Alias -Name sl -Force -Scope Global -ErrorAction SilentlyContinue

      # ==================== TESTS ====================
      - name: Verify Sapling installation
        shell: bash
        run: |
          which sl || echo "sl not in PATH"
          sl --version

      - name: Run tests
        shell: bash
        run: |
          # Debug: show Python info
          python --version
          python -c "import sys; print(sys.executable)"
          # Run tests (use --no-parallel on Windows due to potential issues)
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            python test --report test-results.xml -v --no-parallel
          else
            python test --report test-results.xml -v
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: test-results.xml

      - name: Display test failures (Windows debug)
        if: failure() && runner.os == 'Windows'
        shell: bash
        run: |
          echo "=== Test Results ==="
          cat test-results.xml || echo "No test results file"
          echo ""
          echo "=== Environment ==="
          which sl
          sl --version
          echo "PATH: $PATH"
