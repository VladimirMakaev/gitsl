name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.9", "3.11", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Sapling (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          SAPLING_VERSION="0.2.20250521-115337+25ed6ac4"
          curl -LO "https://github.com/facebook/sapling/releases/download/${SAPLING_VERSION}/sapling_${SAPLING_VERSION}_amd64.Ubuntu22.04.deb"
          sudo dpkg -i sapling_*.deb
          sl --version

      - name: Install Sapling (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install sapling
          sl --version

      - name: Install Sapling (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $SAPLING_VERSION = "0.2.20250521-115337+25ed6ac4"
          $url = "https://github.com/facebook/sapling/releases/download/$SAPLING_VERSION/sapling_windows_${SAPLING_VERSION}_amd64.zip"
          Invoke-WebRequest -Uri $url -OutFile sapling.zip
          Expand-Archive sapling.zip -DestinationPath "$env:LOCALAPPDATA\Sapling"

          # Add to GITHUB_PATH for subsequent steps
          $saplingPath = "$env:LOCALAPPDATA\Sapling\sapling_windows_${SAPLING_VERSION}_amd64"
          echo $saplingPath >> $env:GITHUB_PATH

          # Remove PowerShell sl alias that conflicts with Sapling
          Remove-Alias -Name sl -Force -Scope Global -ErrorAction SilentlyContinue

          # Verify with explicit .exe
          & "$saplingPath\sl.exe" --version

      - name: Remove sl alias (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Remove-Alias -Name sl -Force -Scope Global -ErrorAction SilentlyContinue

      - name: Run tests
        run: python test
